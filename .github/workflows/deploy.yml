name: Deploy Lambda (Blue/Green with Rollback)

on:
  push:
    branches:
      - main
    paths:
      - 'lambda_data_processor.py'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3ï¸âƒ£ Syntax check
      - name: Validate Lambda code
        run: |
          python -m py_compile lambda_data_processor.py

      # 4ï¸âƒ£ Build Lambda ZIP
      - name: Build Lambda package
        run: |
          mkdir -p build/processor
          cp lambda_data_processor.py build/processor/index.py
          cd build/processor
          zip -r ../../processor.zip .
          cd ../..
          ls -lh processor.zip

      # 5ï¸âƒ£ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      # 6ï¸âƒ£ Get current LIVE version (for rollback)
      - name: Get current live version
        id: current
        run: |
          PREV_VERSION=$(aws lambda get-alias \
            --function-name data-pipeline-data-processor \
            --name live \
            --query 'FunctionVersion' \
            --output text || echo "")
          echo "prev=$PREV_VERSION" >> "$GITHUB_OUTPUT"
          echo "Current live version: $PREV_VERSION"

      # 7ï¸âƒ£ Upload new code
      - name: Upload Lambda code
        run: |
          aws lambda update-function-code \
            --function-name data-pipeline-data-processor \
            --zip-file fileb://processor.zip

      # 8ï¸âƒ£ Publish NEW version (green)
      - name: Publish Lambda version
        id: publish
        run: |
          VERSION=$(aws lambda publish-version \
            --function-name data-pipeline-data-processor \
            --query 'Version' \
            --output text)

          echo "Published version: $VERSION"

          if [ -z "$VERSION" ]; then
            echo "ERROR: Lambda version is empty"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # 9ï¸âƒ£ Smoke test NEW version
      - name: Smoke test new version
        run: |
          aws lambda invoke \
            --function-name data-pipeline-data-processor \
            --qualifier ${{ steps.publish.outputs.version }} \
            --payload '{}' response.json
          cat response.json

      # ğŸ”Ÿ Switch alias (Blue â†’ Green)
      - name: Shift traffic to new version
        run: |
          aws lambda update-alias \
            --function-name data-pipeline-data-processor \
            --name live \
            --function-version ${{ steps.publish.outputs.version }}

      # ğŸ” Rollback automatically on failure
      - name: Rollback on failure
        if: failure()
        run: |
          if [ -z "${{ steps.current.outputs.prev }}" ]; then
            echo "No previous version found â€” skipping rollback"
            exit 0
          fi

          echo "Rolling back to version ${{ steps.current.outputs.prev }}"

          aws lambda update-alias \
            --function-name data-pipeline-data-processor \
            --name live \
            --function-version ${{ steps.current.outputs.prev }}
